# PITR DOCUMENTATION

## Notes
- The PITR is best to use when you have to deal with data corruption scenarios, usually generated by machine or
human intervention. For cases like hardware failure, the best choice is to use the default recovery (with or without 
delta option).

## MANUAL PROCEDURE

1) Create table

```
# Create and populate the new table
sudo -u postgres psql -c "create table my_table (message test);"
sudo -u postgres psql -c "insert into my_table values ('Hello World!');"

# Perform a SELECT to check the results
sudo -u postgres psql -c "select * from my_table;"
   message
-------------
 Hello World
(1 row)
```

2) Check the time after you created the table
```
# Check the current time
sudo -u postgres psql -Atc "select curret_timestamp"
2025-07-30 11:50:28.930943+03
```

In practice, finding the exact time the table was dropped is a lot harder than in this example. It may not be possible 
to find the exact time, but some forensic work should be able to get you close.

3) Drop the table
```
# Drop the table created above
sudo -u postgres psql -c "drop table my_table;"

# Perform a SELECT
sudo -u postgres psql -c "select * from my_table;"
```

After you perform that last SELECT, you should get something similar to this:
```
ERROR:  relation "my_table" does not exist
LINE 1: select * from my_table;
```

4) Perform an incremental backup

```
# Perform the incremental backup
sudo -u postgres pgbackrest --stanza=demo --type=incr backup

# Check the backup info
sudo -u postgres pgbackrest info

        incr backup: 20250730-115101F_20250730-115125I
            timestamp start/stop: 2025-07-30 11:51:25+03 / 2025-07-30 11:51:27+03
            wal start/stop: 00000004000000020000000A / 00000004000000020000000A
            database size: 32.2MB, database backup size: 1MB
            repo1: backup size: 5.8KB
            backup reference total: 1 full

```

Now that we recorded the right time when the table was created, we performed the incremental backup and dropped the 
table, the last thing to do is to perform the PITR. 

Before we get to the correct form of restore, we have to pay close attention to the logic behind the PITR. You cannot 
restore to a specific point in time using the wrong backup. What I want to mention here is that you cannot restore to a 
specific point in time using a backup performed after that timestamp. 

In our case, if we were to use this timestamp: `2025-07-30 11:50:28.930943+03` and this backup: 
`20250730-115101F_20250730-115125I` which was performed `2025-07-30 11:51:25+03` we would get an error. The cluster 
status will be `failed`. Look at the steps performed below:

```
# Stop the cluster
sudo systemctl stop postgresql-13

# Try to perfom the restore with a backup performed after the your target time
sudo -u postgres pgbackrest --stanza=demo --delta \
       --set=20250730-115101F_20250730-115125I --target-timeline=current \
       --type=time "--2025-07-30 11:50:28.930943+03" --target-action=promote restore

# Try start the cluster
sudo systemctl start postgresql-13

# Check the postgresql.log file
sudo -u postgres cat /var/lib/pgsql/13/data/log/postgresql.log

2025-07-30 11:56:56.801 EEST [17709] LOG:  redo done at 2/B000060
2025-07-30 11:56:56.802 EEST [17709] FATAL:  recovery ended before configured recovery target was reached
2025-07-30 11:56:56.804 EEST [17707] LOG:  startup process (PID 17709) exited with exit code 1
2025-07-30 11:56:56.804 EEST [17707] LOG:  terminating any other active server processes
2025-07-30 11:56:56.807 EEST [17707] LOG:  database system is shut down

```
Also, if you check the service's status:

```
# Check the cluster status
sudo systemctl status postgresql-13

Ã— postgresql-13.service - PostgreSQL 13 database server
     Loaded: loaded (/usr/lib/systemd/system/postgresql-13.service; enabled; preset: disabled)
     Active: failed (Result: exit-code) since Wed 2025-07-30 11:56:56 EEST; 5min ago
   Duration: 117ms
       Docs: https://www.postgresql.org/docs/13/static/
    Process: 17702 ExecStartPre=/usr/pgsql-13/bin/postgresql-13-check-db-dir ${PGDATA} (code=exited, status=0/SUCCESS)
    Process: 17707 ExecStart=/usr/pgsql-13/bin/postmaster -D ${PGDATA} (code=exited, status=1/FAILURE)
   Main PID: 17707 (code=exited, status=1/FAILURE)
        CPU: 224ms

Jul 30 11:56:56 postgresql-node1 systemd[1]: Starting PostgreSQL 13 database server...
Jul 30 11:56:56 postgresql-node1 postmaster[17707]: 2025-07-30 11:56:56.295 EEST [17707] LOG:  redirecting log output to logging collector process
Jul 30 11:56:56 postgresql-node1 postmaster[17707]: 2025-07-30 11:56:56.295 EEST [17707] HINT:  Future log output will appear in directory "log".
Jul 30 11:56:56 postgresql-node1 systemd[1]: Started PostgreSQL 13 database server.
Jul 30 11:56:56 postgresql-node1 systemd[1]: postgresql-13.service: Main process exited, code=exited, status=1/FAILURE
Jul 30 11:56:56 postgresql-node1 systemd[1]: postgresql-13.service: Killing process 17708 (postmaster) with signal SIGKILL.
Jul 30 11:56:56 postgresql-node1 systemd[1]: postgresql-13.service: Failed with result 'exit-code'.

```

As you can see, the service is failed, because your target time is before the backup you want to use...

The best option is to allow pgBackRest to select a backup capable of recovery to the time target, i.e. a backup that 
ended before the specific time. 


```
# Check the cluster status (it should be failed now)
sudo systemctl status postgresql-13

# Perform the restore
pgbackrest --stanza=demo --delta --type=time "--target=2025-07-30 11:50:28.930943+03" --target-action=promote restore
 
# Start the service
sudo systemctl start postgresql-13

# Check the /var/lib/pgsql/13/data/log/postgresql.log
sudo -u postgres cat /var/lib/pgsql/13/data/log/postgresql.log

2025-07-30 12:07:04.894 EEST [22019] LOG:  redo done at 2/9006CB0
2025-07-30 12:07:04.894 EEST [22019] LOG:  last completed transaction was at log time 2025-07-30 11:50:28.930943+03
2025-07-30 12:07:04.904 EEST [22019] LOG:  selected new timeline ID: 5
2025-07-30 12:07:04.922 EEST [22019] LOG:  archive recovery complete
2025-07-30 12:07:04.929 EEST [22019] LOG:  restored log file "00000004.history" from archive
2025-07-30 12:07:04.954 EEST [22017] LOG:  database system is ready to accept connections

# Check the /var/lib/pgsql/13/data/postgresql.auto.conf
sudo -u postgres cat /var/lib/pgsql/13/data/postgresql.auto.conf

# Recovery settings generated by pgBackRest restore on 2025-07-30 12:06:58
restore_command = 'pgbackrest --stanza=demo archive-get %f "%p"'
recovery_target_time = '2025-07-30 11:50:28.930943+03'
recovery_target_action = 'promote'

```

As you can see, the restore was successful and the following line: 
```
2025-07-30 12:07:04.894 EEST [22019] LOG:  last completed transaction was at log time 2025-07-30 11:50:28.930943+03
```
mentiones that the cluster was brought back to the specified time: `2025-07-30 11:50:28.930943+03`.

The last check: 

```
postgres=# select * from my_table;
   message
-------------
 Hello World
(1 row)

```
